// dllmain.cpp : Defines the entry point for the DLL application.
#include "pch.h"

#include <detours.h>
#include <stdio.h>

#include "Hooks.h"

// Export the function with ordinal number 1
// It is needed to be able to inject the DLL with the fx DetoursCreateProcessWithDllEx
// I think is needed so that the code of our Dll is the first to get executed
// I guess the Dll becomes the entryy point of our binary
// DOCS of DetourCreateProcessWithDllEx
// Note: The new process will fail to start if the target DLL does not contain a exported function with ordinal #1.
extern "C" __declspec(dllexport) void __stdcall EntryPoint()
{
    // nothing for now
}

#define ATTACH(x)       DetourAttach(&(PVOID&)True_##x,Mine_##x)
#define DETACH(x)       DetDetach(&(PVOID&)True_##x,Mine_##x)

BOOL APIENTRY DllMain( HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved )
{
	if (DetourIsHelperProcess()) {
        return TRUE;
    }

	DWORD currentProcessId = GetCurrentProcessId();

    if (ul_reason_for_call == DLL_PROCESS_ATTACH)
    {
        DetourRestoreAfterWith();
        printf("%d ATTACH: I'm the DLL\n", currentProcessId);

        DetourTransactionBegin();
        DetourUpdateThread(GetCurrentThread());
        DetourAttach(&(PVOID&)True_CreateProcess,Mine_CreateProcess);
        DetourAttach(&(PVOID&)TrueWSASend,HookedWSASend);
        DetourTransactionCommit();
    }
    else if (ul_reason_for_call == DLL_PROCESS_DETACH)
    {
        printf("%d DETACH: I'm the DLL\n", currentProcessId);
        DetourTransactionBegin();
        DetourUpdateThread(GetCurrentThread());
        DetourDetach(&(PVOID&)True_CreateProcess, Mine_CreateProcess);
        DetourDetach(&(PVOID&)TrueWSASend,HookedWSASend);
        DetourTransactionCommit();
    }

    return TRUE;

}

