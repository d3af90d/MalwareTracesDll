// dllmain.cpp : Defines the entry point for the DLL application.
#include "pch.h"

#include <detours.h>
#include <stdio.h>
#include <iostream>
#include <fstream>
#include <string>

#include "Hooks.h"
#include "Utils.h"

// Export the function with ordinal number 1
// It is needed to be able to inject the DLL with the fx DetoursCreateProcessWithDllEx
// I think is needed so that the code of our Dll is the first to get executed
// I guess the Dll becomes the entryy point of our binary
// DOCS of DetourCreateProcessWithDllEx
// Note: The new process will fail to start if the target DLL does not contain a exported function with ordinal #1.
extern "C" __declspec(dllexport) void __stdcall EntryPoint()
{
    // nothing for now
}

#define ATTACH(x)       DetourAttach(&(PVOID&)True_##x,Mine_##x)
#define DETACH(x)       DetourDetach(&(PVOID&)True_##x,Mine_##x)

static DWORD tlsIndex = TlsAlloc();
const char* infectedFile = "C:\\malwareTraces\\malwareTracesDll\\infected.txt";

void writeToFile(DWORD pid, DWORD threadId) {
	std::ofstream file(infectedFile, std::ios::app);
	if (file.is_open()) {
		// Append the numbers to the file
		file << pid << " " << threadId << std::endl;
		file.close();
	}
}

void deleteLineFromFile(DWORD pid, DWORD threadId) {


}

BOOL IsCallerInfected(DWORD processId, DWORD ThreadId) {
    std::ifstream inputFile(infectedFile);

	std::string targetLine = std::to_string(processId) + " " + std::to_string(ThreadId);
	std::string lineRead;

    while (std::getline(inputFile, lineRead)) {
        if (lineRead == targetLine) {
			return TRUE;
        }
    }

	inputFile.close();
	return FALSE;
}

BOOL APIENTRY DllMain( HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved )
{
	if (DetourIsHelperProcess()) {
        return TRUE;
    }

	DWORD currentProcessId = GetCurrentProcessId();
    DWORD currentThreadId = GetCurrentThreadId();
	char line[100];
	sprintf_s(line, sizeof(line), "%d %d\r", currentProcessId, currentThreadId);

	switch(ul_reason_for_call)
    {
		case DLL_PROCESS_ATTACH:
			printf("DLL_PROCESS_ATTACH | pid: %d - ThreadId: %d\n", GetCurrentProcessId(), GetCurrentThreadId());
			writeToFile(currentProcessId, currentThreadId);


			DetourRestoreAfterWith();
			DetourTransactionBegin();
			DetourUpdateThread(GetCurrentThread());
			ATTACH(CreateProcess);
			ATTACH(WSASend);
			ATTACH(bind);
			ATTACH(WSASocketW);
			ATTACH(CreateRemoteThread);
			ATTACH(CreateThread);
			DetourTransactionCommit();
			break;

		case DLL_THREAD_ATTACH:
			printf("DLL_THREAD_ATTACH | pid: %d - ThreadId: %d\n", GetCurrentProcessId(), GetCurrentThreadId());
			writeToFile(currentProcessId, currentThreadId);
			break;

		case DLL_THREAD_DETACH:
			printf("DLL_THREAD_DETACH | pid: %d - ThreadId: %d\n", GetCurrentProcessId(), GetCurrentThreadId());
			break;

		case DLL_PROCESS_DETACH:
			printf("DLL_PROCESS_DETACH | pid: %d - ThreadId: %d\n", GetCurrentProcessId(), GetCurrentThreadId());
			DetourTransactionBegin();
			DetourUpdateThread(GetCurrentThread());
			DETACH(CreateProcess);
			DETACH(WSASend);
			DETACH(bind);
			DETACH(WSASocketW);
			DETACH(CreateRemoteThread);
			DETACH(CreateThread);
			DetourTransactionCommit();
			break;
    }
    return TRUE;
}

