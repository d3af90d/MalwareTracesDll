// dllmain.cpp : Defines the entry point for the DLL application.
#include "pch.h"

#include <detours.h>
#include <stdio.h>
#include <iostream>
#include <fstream>
#include <string>

#include "Hooks.h"
#include "Utils.h"

#define ATTACH(x)       DetourAttach(&(PVOID&)True_##x,Mine_##x)
#define DETACH(x)       DetourDetach(&(PVOID&)True_##x,Mine_##x)

/* 
 * Export the function with ordinal number 1
 * It is needed to be able to inject the DLL with the fx DetoursCreateProcessWithDllEx
 * I think is needed so that the code of our Dll is the first to get executed
 * I guess the Dll becomes the entry point of our binary
 * DOCS of DetourCreateProcessWithDllEx
 * Note: The new process will fail to start if the target DLL does not contain a exported function with ordinal #1.
 */ 
extern "C" __declspec(dllexport) void __stdcall EntryPoint() { }

BOOL APIENTRY DllMain( HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved )
{
    if (DetourIsHelperProcess()) {
        return TRUE;
    }

    DWORD currentProcessId = GetCurrentProcessId();
    DWORD currentThreadId = GetCurrentThreadId();
    char line[100];
    sprintf_s(line, sizeof(line), "%d %d\r", currentProcessId, currentThreadId);

    switch(ul_reason_for_call)
    {
        case DLL_PROCESS_ATTACH:
            //printf("%d %d | DLL_PROCESS_ATTACH\n", GetCurrentProcessId(), GetCurrentThreadId());
            //writeToFile(currentProcessId, currentThreadId);

            DetourRestoreAfterWith();
            DetourTransactionBegin();
            DetourUpdateThread(GetCurrentThread());
            // PROCESS & THREADS
            ATTACH(CreateProcess);
            ATTACH(CreateRemoteThread);
            ATTACH(CreateThread);
            // NETWORK
            ATTACH(socket);
            ATTACH(bind);
            ATTACH(WSASend);
            ATTACH(WSARecv);
            ATTACH(WSASocketW);
            ATTACH(WSAStringToAddressW);
            DetourTransactionCommit();

            break;

        case DLL_THREAD_ATTACH:
            //printf("%d %d | DLL_THREAD_ATTACH\n", GetCurrentProcessId(), GetCurrentThreadId());
            writeToFile(currentProcessId, currentThreadId);

            break;

        case DLL_THREAD_DETACH:
            //printf("%d %d | DLL_THREAD_DETACH\n", GetCurrentProcessId(), GetCurrentThreadId());

            break;

        case DLL_PROCESS_DETACH:
            //printf("%d %d | DLL_PROCESS_DETACH\n", GetCurrentProcessId(), GetCurrentThreadId());
            
            DetourTransactionBegin();
            DetourUpdateThread(GetCurrentThread());
            // PROCESS & THREADS
            DETACH(CreateProcess);
            DETACH(CreateRemoteThread);
            DETACH(CreateThread);
            // NETWORK
            DETACH(socket);
            DETACH(bind);
            DETACH(WSASend);
            DETACH(WSARecv);
            DETACH(WSASocketW);
            DETACH(WSAStringToAddressW);
            DetourTransactionCommit();

            break;
    }
    return TRUE;
}

