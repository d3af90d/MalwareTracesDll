#pragma once

#include <winsock2.h>
#include <ws2tcpip.h>

#pragma comment(lib, "ws2_32.lib")

// Import per ICMP
#include <IPExport.h>
#include <icmpapi.h>
#include <iphlpapi.h>

#pragma comment(lib, "iphlpapi.lib")

/*
 * PROCESS AND THREAD CREATION FUNCTION POINTER TYPES
 */
typedef BOOL(WINAPI* FP_DetourCreateProcessWithDllEx)(
    LPCWSTR lpApplicationName,
    LPWSTR lpCommandLine,
    LPSECURITY_ATTRIBUTES lpProcessAttributes,
    LPSECURITY_ATTRIBUTES lpThreadAttributes,
    BOOL bInheritHandles,
    DWORD dwCreationFlags,
    LPVOID lpEnvironment,
    LPCWSTR lpCurrentDirectory,
    LPSTARTUPINFOW lpStartupInfo,
    LPPROCESS_INFORMATION lpProcessInformation,
    LPCSTR lpDllName,
    PDETOUR_CREATE_PROCESS_ROUTINEW pfCreateProcessW
);
FP_DetourCreateProcessWithDllEx True_DetourCreateProcessWithDllEx = DetourCreateProcessWithDllEx;

typedef BOOL (WINAPI* FP_CreateProcess)(
    LPCWSTR lpApplicationName,
    LPWSTR lpCommandLine,
    LPSECURITY_ATTRIBUTES lpProcessAttributes,
    LPSECURITY_ATTRIBUTES lpThreadAttributes,
    BOOL bInheritHandles,
    DWORD dwCreationFlags,
    LPVOID lpEnvironment,
    LPCWSTR lpCurrentDirectory,
    LPSTARTUPINFOW lpStartupInfo,
    LPPROCESS_INFORMATION lpProcessInformation
);
FP_CreateProcess True_CreateProcess = CreateProcess;

typedef HANDLE (WINAPI* FP_CreateThread) (
  LPSECURITY_ATTRIBUTES   lpThreadAttributes,
  SIZE_T                  dwStackSize,
  LPTHREAD_START_ROUTINE  lpStartAddress,
  __drv_aliasesMem LPVOID lpParameter,
  DWORD                   dwCreationFlags,
  LPDWORD                 lpThreadId
);
FP_CreateThread True_CreateThread = CreateThread;

typedef HANDLE (WINAPI* FP_CreateRemoteThread) (
  HANDLE                 hProcess,
  LPSECURITY_ATTRIBUTES  lpThreadAttributes,
  SIZE_T                 dwStackSize,
  LPTHREAD_START_ROUTINE lpStartAddress,
  LPVOID                 lpParameter,
  DWORD                  dwCreationFlags,
  LPDWORD                lpThreadId
);
FP_CreateRemoteThread True_CreateRemoteThread = CreateRemoteThread;

/*
 * NETWORK RELATED FUNCTION POINTERS TYPES
 */

/*
 * WSASend() https://learn.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsasend
 */
typedef int (WSAAPI* FP_WSASend)(
    SOCKET                             s,
    LPWSABUF                           lpBuffers,
    DWORD                              dwBufferCount,
    LPDWORD                            lpNumberOfBytesSent,
    DWORD                              dwFlags,
    LPWSAOVERLAPPED                    lpOverlapped,
    LPWSAOVERLAPPED_COMPLETION_ROUTINE lpCompletionRoutine
);
FP_WSASend True_WSASend = WSASend;

/*
 * WSARecv() https://learn.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsarecv
 */
typedef int (WSAAPI* FP_WSARecv) (
  SOCKET                             s,
  LPWSABUF                           lpBuffers,
  DWORD                              dwBufferCount,
  LPDWORD                            lpNumberOfBytesRecvd,
  LPDWORD                            lpFlags,
  LPWSAOVERLAPPED                    lpOverlapped,
  LPWSAOVERLAPPED_COMPLETION_ROUTINE lpCompletionRoutine
);
FP_WSARecv True_WSARecv = WSARecv;

/*
 * WSAStringToAddressW() https://learn.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsastringtoaddressw
 */
typedef INT (WSAAPI* FP_WSAStringToAddressW) (
  LPWSTR               AddressString,
  INT                 AddressFamily,
  LPWSAPROTOCOL_INFOW lpProtocolInfo,
  LPSOCKADDR          lpAddress,
  LPINT               lpAddressLength
);
FP_WSAStringToAddressW True_WSAStringToAddressW = WSAStringToAddressW;

/*
 * WSASocketW()
 */
typedef SOCKET (WSAAPI* FP_WSASocketW)(
  int                 af,
  int                 type,
  int                 protocol,
  LPWSAPROTOCOL_INFOW lpProtocolInfo,
  GROUP               g,
  DWORD               dwFlags
);
FP_WSASocketW True_WSASocketW = WSASocketW;

/*
 * bind https://learn.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-bind
 */
typedef int (WINAPI* FP_bind)(
  SOCKET         s,
  const sockaddr *addr,
  int            namelen
);
FP_bind True_bind = bind;

/*
 * socket() https://learn.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-socket
 */
typedef SOCKET (WSAAPI* FP_socket) (
  int af,
  int type,
  int protocol
);
FP_socket True_socket = socket;

// IPHelper
// https://learn.microsoft.com/en-us/windows/win32/api/_iphlp/

// IN_ADDR | IpAddr structure https://learn.microsoft.com/en-us/windows/win32/api/inaddr/ns-inaddr-in_addr

// DNS
// GetAddrInfoW() https://learn.microsoft.com/en-us/windows/win32/api/ws2tcpip/nf-ws2tcpip-getaddrinfow
typedef INT (WSAAPI* FP_GetAddrInfoW)(
  PCWSTR          pNodeName,
  PCWSTR          pServiceName,
  const ADDRINFOW *pHints,
  PADDRINFOW      *ppResult
);
FP_GetAddrInfoW True_GetAddrInfoW = GetAddrInfoW;

// getaddrinfo() https://learn.microsoft.com/en-us/windows/win32/api/ws2tcpip/nf-ws2tcpip-getaddrinfo
typedef INT (WSAAPI* FP_getaddrinfo)(
  PCSTR           pNodeName,
  PCSTR           pServiceName,
  const ADDRINFOA *pHints,
  PADDRINFOA      *ppResult
);
FP_getaddrinfo True_getaddrinfo = getaddrinfo;

// Non riesco a seguire le chiamate API che mi fanno fare la richiesta DNS
// Probabilmente se ne occupa un altro processo di Windows a fare la richiesta effettiva
// Per risolvere il problema posso salvare il nome di dominio di cui vuole l'IP e poi ritrovare quella richiesta nelle richieste DNS
// Il problema e' che ora alcune richieste DNS non sono in chiaro

//ARP
// SendARP()
// https://learn.microsoft.com/en-us/windows/win32/api/iphlpapi/nf-iphlpapi-sendarp

//ICMP
// icmpapi.h https://learn.microsoft.com/en-us/windows/win32/api/icmpapi/
// IcmpCreateFile() https://learn.microsoft.com/en-us/windows/win32/api/icmpapi/nf-icmpapi-icmpcreatefile
// IcmpSendEcho() https://learn.microsoft.com/en-us/windows/win32/api/icmpapi/nf-icmpapi-icmpsendecho
// IcmpSendEcho2() https://learn.microsoft.com/en-us/windows/win32/api/icmpapi/nf-icmpapi-icmpsendecho2
// dwRetVal = IcmpSendEcho2(hIcmpFile, NULL, NULL, NULL, ipaddr, SendData, sizeof (SendData), NULL, ReplyBuffer, ReplySize, 1000);
// In ReplyBuffer vengono salvate le informazioni sulla risposta
// Vedere se si possono avere richiesta e risposta solo attraverso l'hooking


/*
 * IcmpSendEcho2Ex() https://learn.microsoft.com/en-us/windows/win32/api/icmpapi/nf-icmpapi-icmpsendecho2ex
 * Ho dovuto cambiare il tipo di ApcRoutine da PIO_APC_ROUTINE in FARPROC
 * Mi diceva che IcmpSendEcho2Ex ha come tipo FARPROC, ma la documentazione dice diversamente
 * Devo vedere che relazione c'e' tra PIO_APC_ROUTINE e FARPROC
 */
typedef IPHLPAPI_DLL_LINKAGE DWORD (* FP_IcmpSendEcho2Ex) (
  HANDLE                 IcmpHandle,
  HANDLE                 Event,
  FARPROC                ApcRoutine,
  PVOID                  ApcContext,
  IPAddr                 SourceAddress,
  IPAddr                 DestinationAddress,
  LPVOID                 RequestData,
  WORD                   RequestSize,
  PIP_OPTION_INFORMATION RequestOptions,
  LPVOID                 ReplyBuffer,
  DWORD                  ReplySize,
  DWORD                  Timeout
);
FP_IcmpSendEcho2Ex True_IcmpSendEcho2Ex = IcmpSendEcho2Ex;

// Funzioni utili a convertire IP, indirizzi MAC e porte in stringhe
// ip2string.h https://learn.microsoft.com/en-us/windows/win32/api/ip2string/

// SOCKADDR_INET union https://learn.microsoft.com/en-us/windows/win32/api/ws2ipdef/ns-ws2ipdef-sockaddr_inet

// WSASend()
// WSARecv()
// setsockopt??

// bind - setsockopt - WSASend - WSARecv* - shutdown - closesocket
// bind( ListenSocket,(SOCKADDR*) &saServer, sizeof(saServer) );

// send() https://learn.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-send
typedef int (WSAAPI*  FP_send)(
  SOCKET     s,
  const char *buf,
  int        len,
  int        flags
);
FP_send True_send = send;

// recv() https://learn.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-recv
typedef int (* FP_recv) (
  SOCKET s,
  char   *buf,
  int    len,
  int    flags
);
FP_recv True_recv = recv;

// Windows Socket 2
// https://learn.microsoft.com/en-us/windows/win32/api/_winsock/
// sockaddr https://learn.microsoft.com/en-us/windows/win32/winsock/sockaddr-2


