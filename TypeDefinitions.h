#pragma once

#include <winsock2.h>
#include <ws2tcpip.h>

#pragma comment(lib, "ws2_32.lib")

/*
 * PROCESS AND THREAD CREATION FUNCTION POINTER TYPES
 */
typedef BOOL(WINAPI* FPDetourCreateProcessWithDllEx)(
    LPCWSTR lpApplicationName,
    LPWSTR lpCommandLine,
    LPSECURITY_ATTRIBUTES lpProcessAttributes,
    LPSECURITY_ATTRIBUTES lpThreadAttributes,
    BOOL bInheritHandles,
    DWORD dwCreationFlags,
    LPVOID lpEnvironment,
    LPCWSTR lpCurrentDirectory,
    LPSTARTUPINFOW lpStartupInfo,
    LPPROCESS_INFORMATION lpProcessInformation,
    LPCSTR lpDllName,
    PDETOUR_CREATE_PROCESS_ROUTINEW pfCreateProcessW
);
FPDetourCreateProcessWithDllEx True_DetourCreateProcessWithDllEx = DetourCreateProcessWithDllEx;

typedef BOOL (WINAPI* FPCreateProcess)(
    LPCWSTR lpApplicationName,
    LPWSTR lpCommandLine,
    LPSECURITY_ATTRIBUTES lpProcessAttributes,
    LPSECURITY_ATTRIBUTES lpThreadAttributes,
    BOOL bInheritHandles,
    DWORD dwCreationFlags,
    LPVOID lpEnvironment,
    LPCWSTR lpCurrentDirectory,
    LPSTARTUPINFOW lpStartupInfo,
    LPPROCESS_INFORMATION lpProcessInformation
);
FPCreateProcess True_CreateProcess = CreateProcess;

typedef HANDLE (WINAPI* FPCreateThread) (
  LPSECURITY_ATTRIBUTES   lpThreadAttributes,
  SIZE_T                  dwStackSize,
  LPTHREAD_START_ROUTINE  lpStartAddress,
  __drv_aliasesMem LPVOID lpParameter,
  DWORD                   dwCreationFlags,
  LPDWORD                 lpThreadId
);
FPCreateThread True_CreateThread = CreateThread;

typedef HANDLE (WINAPI* FPCreateRemoteThread) (
  HANDLE                 hProcess,
  LPSECURITY_ATTRIBUTES  lpThreadAttributes,
  SIZE_T                 dwStackSize,
  LPTHREAD_START_ROUTINE lpStartAddress,
  LPVOID                 lpParameter,
  DWORD                  dwCreationFlags,
  LPDWORD                lpThreadId
);
FPCreateRemoteThread True_CreateRemoteThread = CreateRemoteThread;

/*
 * NETWORK RELATED FUNCTION POINTERS TYPES
 */

/*
 * WSASend() https://learn.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsasend
 */
typedef int (WSAAPI* FPWSASend)(
    SOCKET                             s,
    LPWSABUF                           lpBuffers,
    DWORD                              dwBufferCount,
    LPDWORD                            lpNumberOfBytesSent,
    DWORD                              dwFlags,
    LPWSAOVERLAPPED                    lpOverlapped,
    LPWSAOVERLAPPED_COMPLETION_ROUTINE lpCompletionRoutine
);
FPWSASend True_WSASend = WSASend;

/*
 * WSARecv() https://learn.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsarecv
 */
typedef int (WSAAPI* FPWSARecv) (
  SOCKET                             s,
  LPWSABUF                           lpBuffers,
  DWORD                              dwBufferCount,
  LPDWORD                            lpNumberOfBytesRecvd,
  LPDWORD                            lpFlags,
  LPWSAOVERLAPPED                    lpOverlapped,
  LPWSAOVERLAPPED_COMPLETION_ROUTINE lpCompletionRoutine
);
FPWSARecv True_WSARecv = WSARecv;

/*
 * WSAStringToAddressW() https://learn.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsastringtoaddressw
 */
typedef INT (WSAAPI* FPWSAStringToAddressW) (
  LPWSTR               AddressString,
  INT                 AddressFamily,
  LPWSAPROTOCOL_INFOW lpProtocolInfo,
  LPSOCKADDR          lpAddress,
  LPINT               lpAddressLength
);
FPWSAStringToAddressW True_WSAStringToAddressW = WSAStringToAddressW;

/*
 * WSASocketW()
 */
typedef SOCKET (WSAAPI* FPWSASocketW)(
  int                 af,
  int                 type,
  int                 protocol,
  LPWSAPROTOCOL_INFOW lpProtocolInfo,
  GROUP               g,
  DWORD               dwFlags
);
FPWSASocketW True_WSASocketW = WSASocketW;

/*
 * bind https://learn.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-bind
 */
typedef int (WINAPI* FPbind)(
  SOCKET         s,
  const sockaddr *addr,
  int            namelen
);
FPbind True_bind = bind;

/*
 * socket() https://learn.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-socket
 */
typedef SOCKET (WSAAPI* FPsocket) (
  int af,
  int type,
  int protocol
);
FPsocket True_socket = socket;

// IPHelper
// https://learn.microsoft.com/en-us/windows/win32/api/_iphlp/

// IN_ADDR | IpAddr structure https://learn.microsoft.com/en-us/windows/win32/api/inaddr/ns-inaddr-in_addr

// DNS
// GetAddrInfoW()
// getaddrinfo()
// Non riesco a seguire le chiamate API che mi fanno fare la richiesta DNS
// Probabilmente se ne occupa un altro processo di Windows a fare la richiesta effettiva
// Per risolvere il problema posso salvare il nome di dominio di cui vuole l'IP e poi ritrovare quella richiesta nelle richieste DNS
// Il problema e' che ora alcune richieste DNS non sono in chiaro

//ARP
// SendARP()
// https://learn.microsoft.com/en-us/windows/win32/api/iphlpapi/nf-iphlpapi-sendarp

//ICMP
// icmpapi.h https://learn.microsoft.com/en-us/windows/win32/api/icmpapi/
// IcmpCreateFile() https://learn.microsoft.com/en-us/windows/win32/api/icmpapi/nf-icmpapi-icmpcreatefile
// IcmpSendEcho() https://learn.microsoft.com/en-us/windows/win32/api/icmpapi/nf-icmpapi-icmpsendecho
// IcmpSendEcho2() https://learn.microsoft.com/en-us/windows/win32/api/icmpapi/nf-icmpapi-icmpsendecho2
// IcmpSendEcho2Ex() https://learn.microsoft.com/en-us/windows/win32/api/icmpapi/nf-icmpapi-icmpsendecho2ex
// dwRetVal = IcmpSendEcho2(hIcmpFile, NULL, NULL, NULL, ipaddr, SendData, sizeof (SendData), NULL, ReplyBuffer, ReplySize, 1000);
// In ReplyBuffer vengono salvate le informazioni sulla risposta
// Vedere se si possono avere richiesta e risposta solo attraverso l'hooking


// Funzioni utili a convertire IP, indirizzi MAC e porte in stringhe
// ip2string.h https://learn.microsoft.com/en-us/windows/win32/api/ip2string/

// SOCKADDR_INET union https://learn.microsoft.com/en-us/windows/win32/api/ws2ipdef/ns-ws2ipdef-sockaddr_inet

// WSASend()
// WSARecv()
// setsockopt??

// bind - setsockopt - WSASend - WSARecv* - shutdown - closesocket
// bind( ListenSocket,(SOCKADDR*) &saServer, sizeof(saServer) );

// Windows Socket 2
// https://learn.microsoft.com/en-us/windows/win32/api/_winsock/

// sockaddr https://learn.microsoft.com/en-us/windows/win32/winsock/sockaddr-2


