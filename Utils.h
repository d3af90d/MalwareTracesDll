#pragma once

#include <Windows.h>
#include <stdio.h>
#include <stdlib.h>

static LPCSTR Mine_Dll = "C:\\Users\\user\\source\\repos\\MalwareTracesDll\\x64\\Debug\\MalwareTracesDll.dll";
static const char* infectedFile = "C:\\malwareTraces\\malwareTracesDll\\infected.txt";
static const char* logFile = "C:\\malwareTraces\\malwareTracesDll\\log.txt";


/*
 * La funzioni in questo file sono tutte da aggiustare
 */

BOOL loadLibraryOnRemoteProcess(DWORD targetPid, const char* dll)
{
    HANDLE hTargetProcess =  OpenProcess(PROCESS_VM_OPERATION | PROCESS_VM_WRITE | PROCESS_CREATE_THREAD, FALSE, targetPid);
    LPVOID remoteDllString = VirtualAllocEx(hTargetProcess, NULL, strlen(dll) + 1, MEM_COMMIT, PAGE_READWRITE);
    WriteProcessMemory(hTargetProcess, remoteDllString, dll, strlen(dll) + 1, NULL);
    PTHREAD_START_ROUTINE pThreadRtn = (PTHREAD_START_ROUTINE) GetProcAddress(GetModuleHandleW(L"kernel32.dll"), "LoadLibraryA");
    HANDLE hRemoteThread = True_CreateRemoteThread(hTargetProcess, NULL, 0, pThreadRtn, remoteDllString, 0, NULL);
    WaitForSingleObject(hRemoteThread, INFINITE);
    return TRUE;
}

void writeToFile(DWORD pid, DWORD threadId) {
    std::ofstream file(infectedFile, std::ios::app);
    if (file.is_open()) {
        // Append the numbers to the file
        file << pid << " " << threadId << std::endl;
        file.close();
    }
}

BOOL IsCallerInfected(DWORD processId, DWORD ThreadId) {
    std::ifstream inputFile(infectedFile);

    std::string targetLine = std::to_string(processId) + " " + std::to_string(ThreadId);
    std::string lineRead;

    // Devo aprire il file? non l'ho eseguita mai ancora
    while (std::getline(inputFile, lineRead)) {
        if (lineRead == targetLine) {
            return TRUE;
        }
    }

    inputFile.close();
    return FALSE;
}

void GetSocketInfo(
    SOCKET s, 
    char* srcIp,
    u_short* srcPort,
    char* dstIp, 
    u_short* dstPort,
    int* Protocol,
    int* AddressFamily,
    int* SocketType
) {
    struct sockaddr_storage remoteAddr;
    int remoteAddrLen = sizeof(remoteAddr);
    char AddrName[NI_MAXHOST];
    WSAPROTOCOL_INFOW protocolInfo;
	int protocolInfoLen = sizeof(protocolInfo);

    if (getpeername(s, (LPSOCKADDR)&remoteAddr, &remoteAddrLen) != 0) {
        printf("getpeername() failed - Error %d\n", WSAGetLastError());
        return;
    }

	char remoteIP[INET_ADDRSTRLEN];
    char servName[NI_MAXSERV];

    /* getnameinfo()
     * https://learn.microsoft.com/en-us/windows/win32/api/ws2tcpip/nf-ws2tcpip-getnameinfo
     * Forzo al rappresentazione numerica dell'host e del servizio. L'eventuale nome di dominio viene intercettato con altri hook
     */
	if (getnameinfo((LPSOCKADDR)&remoteAddr, remoteAddrLen, AddrName, sizeof(AddrName), servName, sizeof(servName), NI_NUMERICHOST|NI_NUMERICSERV) != 0)
		puts("Nome non conosciuto");

    printf("Servizio: %s\n", servName);
	strncpy_s(dstIp, _countof(AddrName), AddrName,_TRUNCATE);
	*dstPort = ntohs(SS_PORT(&remoteAddr));
	printf("Client: Connected to %s, port %d, protocol , protocol family \n", dstIp, *dstPort);

    if (getsockname(s, (LPSOCKADDR)&remoteAddr, &remoteAddrLen) == SOCKET_ERROR)
    {
        fprintf(stderr, "Client: getsockname() failed with error %d\n", WSAGetLastError());
        return;
    }

    printf("Client: getsockname() is OK.\n");
	if (getnameinfo((LPSOCKADDR)&remoteAddr, remoteAddrLen, AddrName, sizeof(AddrName), NULL, 0, NI_NUMERICHOST) != 0)
		puts("Nome non conosciuto");

    strncpy_s(srcIp, _countof(AddrName), AddrName,_TRUNCATE);
	*srcPort = ntohs(SS_PORT(&remoteAddr));
	printf("Client: Using local address %s, port %d\n", srcIp, *srcPort);

	if (getsockopt(s, SOL_SOCKET, SO_PROTOCOL_INFO, (char*)&protocolInfo, &protocolInfoLen) != 0) {
		printf("Client: Unable to retrieve protocol and protocol family - Error %d\n", WSAGetLastError());
        return;
	}

	*Protocol = protocolInfo.iProtocol;
	*AddressFamily = protocolInfo.iAddressFamily;
	*SocketType = protocolInfo.iSocketType;

	printf("Client: Protocol: %d\n", *Protocol);
	printf("Client: Protocol Family: %d\n", *AddressFamily);
	printf("Client: SocktType: %d\n", *SocketType);
}
